<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MDG Material Form (Cloud) – Integrated</title>
    <!--
      This form provides a Fiori‑inspired user interface for creating material
      descriptions and classifications.  It reads its configuration from a
      JSON file generated from your latest SAP MDG export.  To keep the
      experience simple for end‑users the data source and submission URLs
      are hidden – they are defined as constants in this file.  If you
      provide a Google Apps Script endpoint for `DATA_URL` the page will
      fetch the latest classes, characteristic definitions, attributes and
      allowed values from your Google Sheet; otherwise it will fall back to
      `LOCAL_JSON_URL` which points at a bundled `data/form_data.json` file.

      The JSON structure expected matches the one produced by the provided
      `export_data.gs` script.  If your JSON uses the keys `char_desc`,
      `char_attr` and `char_values`, the loader will map them to the
      structure this form understands (`descriptions`, `attributes`, and
      `values`).  This means you do not need to modify the static JSON –
      simply regenerate it when your source data changes and replace
      `data/form_data.json` in this package.
    -->
    <style>
      /* SAP Fiori‑like colour palette */
      :root {
        --sap-brand: #0a6ed1;
        --sap-background: #f5f6f8;
        --sap-surface: #ffffff;
        --sap-border: #d1d8e0;
        --sap-text: #32363a;
        --sap-subtext: #6a6d70;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: "72", Arial, sans-serif;
        background-color: var(--sap-background);
        color: var(--sap-text);
      }
      header {
        background-color: var(--sap-brand);
        color: #fff;
        padding: 1rem 1.5rem;
        font-size: 1.25rem;
        font-weight: bold;
      }
      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: var(--sap-surface);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 600;
      }
      input[type="text"],
      select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--sap-border);
        border-radius: 4px;
        font-size: 1rem;
      }
      input[type="text"]:disabled,
      select:disabled {
        background-color: #f0f0f0;
      }
      .char-row {
        border-top: 1px solid var(--sap-border);
        padding: 1rem;
        margin-top: 1rem;
        background-color: #f9fafb;
        border-radius: 4px;
      }
      .char-row:first-child {
        border-top: none;
        margin-top: 0;
        padding-top: 0;
      }
      .char-row .desc {
        margin-top: 0.25rem;
        font-size: 0.85rem;
        color: var(--sap-subtext);
      }
      .btn {
        display: inline-block;
        background-color: var(--sap-brand);
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        margin-right: 0.5rem;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: default;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th, td {
        padding: 0.5rem;
        text-align: left;
      }
      th {
        border-bottom: 1px solid var(--sap-border);
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>MDG Material Description &amp; Classification Form</header>
    <div class="container">
      <div class="form-group">
        <label for="classInput">Class</label>
        <input
          list="classList"
          id="classInput"
          name="classInput"
          placeholder="Search or select a class"
        />
        <datalist id="classList"></datalist>
      </div>
      <div class="form-group">
        <label for="serverRef">Server Reference</label>
        <input type="text" id="serverRef" placeholder="e.g. TPR" />
      </div>
      <div class="form-group">
        <label for="midRef">MID Reference</label>
        <input type="text" id="midRef" placeholder="e.g. 20030" />
      </div>
      <div class="form-group">
        <label for="companySelect">Company Use For</label>
        <select id="companySelect"></select>
      </div>
      <div id="charContainer"></div>
      <div class="form-group">
        <button class="btn" id="generateBtn">Generate Summary</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
      <div id="resultSection"></div>
    </div>

    <script>
      /**
       * Configuration constants
       *
       * DATA_URL   - if provided, the page will fetch JSON from this URL.  Use
       *              the URL of your Google Apps Script (exporter) endpoint.
       * SUBMIT_URL - if provided, payloads will be posted to this URL when
       *              Generate Summary is clicked.  Use the URL of your
       *              Google Apps Script (receiver) endpoint.  Leave blank to
       *              disable logging.
       * LOCAL_JSON_URL - fallback path to bundled JSON file.  When DATA_URL
       *              is blank, data will be loaded from this path instead.
       */
      const DATA_URL = "https://script.google.com/macros/s/AKfycbxUM3duHP-07Lsy25AeMA7o2KubM707LhxoknuRv3RCP5vpVgwb-259e4-zBy42rLgANw/exec";
      const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbzbLZUtvSxjBKOkpEOYgrxoDfXkg1H2K5ug-DTIKGpUH29RgM5-JIhedHqukAPpmWsr/exec";
      const LOCAL_JSON_URL = "./data/form_data.json";

      // Will hold the configuration loaded from JSON
      let data = null;

      // List of companies.  Update this array as needed.  It mirrors the
      // exhaustive list provided by the user for PT Wings distribution.
      const companies = [
        "PT Sayap Mas Utama",
        "PT Wings Surya",
        "PT Karunia Alam Segar",
        "PT Prakarsa Alam Segar",
        "PT. Multi Duta Utari",
        "PT Tirta Alam Segar",
        "PT Sriwijaya Alam Segar",
        "PT Mitra Alam Segar",
        "PT. Harum Alam Segar",
        "PT Lestari Alam Segar",
        "PT Multi Indomandiri",
        "PT Aneka Mitra Gemilang",
        "PT Bumi Alam Segar",
        "PT Paramasuka Gupita",
        "PT Alam Perkasa Lestari",
        "PT KARUNIA INDAH ABADI",
        "PT KARUNIA INDAH SEGAR",
        "PT. Sehat Alam Segar",
        "PT Daya Anugrah Mulya",
        "PT Citra Utama Dist Raya",
        "PT. Multi Inti Parahiyang",
        "PT Jambi Distribusindo Ry",
        "PT Lampung Distribusindo",
        "PT Padang Distribusindo",
        "Pekanbaru Distribusindo",
        "PT Bintang Utama Distrib",
        "PT Citra Pratama Distribu",
        "PT Intikencana Wiraputera",
        "PT Bengkulu Distribusindo",
        "PT Medan Distribusindo Ry",
        "PT Aceh Distribusindo Ray",
        "PT Pangkalpinang Distribu",
        "PT Banjar Distribusindo",
        "PT Bekasi Distribusindo",
        "PT Belitung Distribusindo",
        "PT Balaraja Distribusindo",
        "PT Depok Distribusindo Ry",
        "PT Serpong Alam Lestari",
        "PT Sriwijaya Distribusind",
        "PT Bukittinggi Mandiri Se",
        "PT Bukittinggi Mandiri Sejahtera",
        "PT Muara Bungo Mandiri",
        "PT Intiniaga Jayakarya",
        "PT Sinarniaga Anugrahmulya",
        "PT Wagekarya Wahyulestari",
        "PT Inti Niaga Pranasari",
        "PT Kuncimas Niagatama",
        "PT Citra Niaga Karya Lestari",
        "PT Intidaya Rajawali Mulia",
        "PT Fajarmula Abadi",
        "PT Intiniaga Tunassejahtera",
        "PT Cipta Karya Agung Abadi",
        "PT Bahagia Sumber Abadi",
        "PT Kalimas Kharisma",
        "PT Sumber Kahayan Kharisma",
        "PT Kumala Niagatama",
        "PT Segar Harum Kalimantan",
        "PT KawiPusaka Raharja",
        "PT Surya Setia Sejahtera",
        "PT Timurjaya Dayatama",
        "PT Awet Sarana Sukses",
        "PT Karya Makmur Agung Cemerlang",
        "PT Inti Harum Sentosa",
        "PT Ciptalaku Lestari",
        "PT Puji Anugerah Alami",
        "PT Anugerah Agung Alami",
        "PT CIPTA GAGAS LESTARI",
        "PT DINAMIKA DAYA SEGARA",
        "PT Tekad Karya Putera",
        "PT Dinamika Indah Cemerlang",
        "PT Sumedang Karunia Sejahtera",
        "PT Padalarang Makmur Abadi",
        "PT Karunia Unggul Semesta",
        "PT Jatiasih Distribusindo Raya",
        "PT Tambun Distribusindo Raya",
        "PT Karawang Distribusindo Raya",
        "PT Marunda Distribusindo Raya",
        "PT Lebak Distribusindo Raya",
        "PT Palabuhan Ratu Distribusindo Raya",
        "PT Cilegon Distribusindo Raya",
        "PT Garut Prakarsa Mandiri",
        "PT Cianjur Alam Utama",
        "PT Bandung Utama Mandiri",
        "PT Sukabumi Alam Mandiri",
        "PT Leuwiliang Segar Prakarsa",
        "PT Soreang Prakarsa Lestari",
        "PT Cikampek Mulya Abadi",
        "PT Tangerang Prakarsa Mandiri",
        "PT Cileunyi Mulya Abadi",
        "PT Serang Mulya Abadi",
        "PT Bogor Anugrah Mulya",
        "PT Rangkas Mulya Sentosa",
        "PT Kamal Unggul Abadi",
        "PT Cicurug Anugrah Raharja",
        "PT Nusa Bakti Indah Alam",
        "PT Karya Gagas Mulia",
        "PT Bina Agung Cipta Bersama",
        "PT Retail Perdana Mandiri",
        "PT Natural Parahita Sejahtera",
        "PT Multi Sarana Rentalindo",
        "PT Cahaya Info Semesta",
        "PT Kreasi Indah Berkarya",
        "CV KAWI SURYA CEMERLANG",
        "CV MAKMUR JAYA SUKSES",
        "PT RETAIL MITRA BERSAMA",
        "PT Subang Mulya Sejahtera",
        "PT Lion Wings",
        "PT Calbee Wingsfood",
        "PT Glico Wings",
        "Paranaque",
        "Cebu",
        "Cagayan De Oro",
        "Davao",
        "GSPI-Ecommerce",
        "XXX Carmona 1",
        "XXX Carmona 2",
        "Davao 2",
        "Camona",
        "Zero Stock",
        "Gentle Supreme Sdn Bhd",
        "Selangor (Shah Alam)",
        "Pulau Pinang",
        "Pahang",
        "Johor",
        "GSM-Ecommerce",
        "Selangor (Alam Megah)",
        "Selangor (Mapletree)",
        "EMANL Head Office",
        "Agbara RO",
        "Lagos Depot",
        "Isolo Depot",
        "Amuwo Depot",
        "Ibadan Depot",
        "Onitsha Depot",
        "Aba Depot",
        "Agbara Depot",
        "Ikeja Distribution Center",
        "Amuwo Distribution Center",
        "Kano Distribution Center",
        "Kano Dakata Depot",
        "AbujaDepot",
        "Kano Kakakra Depot",
        "Depot Sokoto",
        "Depot Gombe",
        "Lagos Primebisco Nigeria Limited",
        "Newbisco Limited",
        "Liquid LQ",
        "Powder ES",
        "Powder NP",
        "PT Jonggol Anugerah Seja",
        "PT. MITRA ALAM SEGAR",
        "PT Palembang Distribusind",
        "PT Bersama Distribusindo",
        "PT Alas Pusaka",
        "PT Wahana Sayap Kencana",
        "PT Niagatama Intimulia",
        "PT Intidaya Rajawali Muli",
        "PT Niagatama Raharja",
        "PT Wahana Wings Surya",
        "PT. Tekad Karya Putera",
        "PT Tangerang Prakarsa Man",
        "PT. NUSA BAKTI INDAH ALAM",
        "PT. Karya Gagas Mulia",
        "PT.Bina Agung Cipta Bersa",
        "PT Lintas Bersama Logistik",
        "PT. KARYAINDAH ALAM SEJAHTERA",
        "PT Natural Mitra Surya",
      ];

      /**
       * Fetch configuration data from DATA_URL or fall back to LOCAL_JSON_URL.
       * After loading, normalise the structure to the format expected by
       * buildCharacteristics().  If the JSON uses char_desc/char_attr/
       * char_values keys these will be converted into descriptions,
       * attributes and values maps.
       */
      async function loadData() {
        const url = DATA_URL || LOCAL_JSON_URL;
        try {
          const response = await fetch(url);
          const json = await response.json();
          // If the JSON has char_desc keys, reshape into the expected format
          if (json.char_desc) {
            data = { classes: json.classes || [], descriptions: {}, attributes: {}, values: {} };
            // copy descriptions
            Object.entries(json.char_desc).forEach(([key, desc]) => {
              data.descriptions[key] = desc;
            });
            // map attributes: entry_required -> required, additional_values -> additional
            Object.entries(json.char_attr || {}).forEach(([key, attrs]) => {
              data.attributes[key] = {
                required: !!attrs.entry_required,
                additional: !!attrs.additional_values,
              };
            });
            // map values: list of allowed values with default indicator
            Object.entries(json.char_values || {}).forEach(([key, list]) => {
              data.values[key] = list.map((v) => ({ value: v.value, default: !!v.default }));
            });
          } else {
            // assume the JSON already has classes, descriptions, attributes, values fields
            data = json;
          }
        } catch (err) {
          console.error('Failed to load configuration', err);
          data = { classes: [], descriptions: {}, attributes: {}, values: {} };
        }
      }

      /** Populate the company dropdown */
      function populateCompanies() {
        const select = document.getElementById('companySelect');
        select.innerHTML = '';
        companies.forEach((c) => {
          const option = document.createElement('option');
          option.value = c;
          option.textContent = c;
          select.appendChild(option);
        });
      }

      /** Populate the datalist with class names */
      function populateClassList() {
        const listEl = document.getElementById('classList');
        listEl.innerHTML = '';
        (data.classes || []).forEach((cls) => {
          const option = document.createElement('option');
          option.value = cls.name;
          option.textContent = cls.name;
          listEl.appendChild(option);
        });
      }

      /** Find a class object by name (case insensitive) */
      function findClass(name) {
        return (data.classes || []).find(
          (cls) => cls.name.toLowerCase() === name.toLowerCase()
        );
      }

      /** Clear any previously rendered characteristics */
      function clearCharacteristics() {
        document.getElementById('charContainer').innerHTML = '';
      }

      /** Convert words to Title Case */
      function toTitleCase(str) {
        return str.replace(/\w\S*/g, function (txt) {
          return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
      }

      /** Build characteristic input rows for a selected class */
      function buildCharacteristics(clsObj) {
        const container = document.getElementById('charContainer');
        container.innerHTML = '';
        if (!clsObj || !clsObj.characteristics) return;
        clsObj.characteristics
          .slice() // copy array to avoid mutating original
          .sort((a, b) => a.sequence - b.sequence)
          .forEach((ch) => {
            const row = document.createElement('div');
            row.className = 'char-row';
            // Label
            const label = document.createElement('label');
            label.textContent = ch.char_name;
            row.appendChild(label);
            // Description
            const descSpan = document.createElement('div');
            descSpan.className = 'desc';
            if (data.descriptions && data.descriptions[ch.char_name]) {
              descSpan.textContent = data.descriptions[ch.char_name];
            }
            row.appendChild(descSpan);
            // Determine allowed values and attributes
            const values = (data.values && data.values[ch.char_name]) || [];
            const attr = (data.attributes && data.attributes[ch.char_name]) || {};
            let input;
            if (values.length > 0 && !attr.additional) {
              // Use a <select> when allowed values and additional values not allowed
              input = document.createElement('select');
              const placeholder = document.createElement('option');
              placeholder.value = '';
              placeholder.textContent = '-- Select --';
              placeholder.disabled = attr.required;
              placeholder.selected = true;
              input.appendChild(placeholder);
              values.forEach((v) => {
                const option = document.createElement('option');
                option.value = v.value;
                option.textContent = v.value;
                if (v.default) option.selected = true;
                input.appendChild(option);
              });
            } else {
              // Use a text input when free text or additional values allowed
              input = document.createElement('input');
              input.type = 'text';
              input.placeholder = 'Enter value';
              if (values.length > 0) {
                // Provide suggestions via datalist
                const listId = `dl_${ch.char_name}`;
                const dl = document.createElement('datalist');
                dl.id = listId;
                values.forEach((v) => {
                  const opt = document.createElement('option');
                  opt.value = v.value;
                  dl.appendChild(opt);
                });
                document.body.appendChild(dl);
                input.setAttribute('list', listId);
              }
            }
            // Store metadata on the input for summary generation
            input.dataset.charName = ch.char_name;
            input.dataset.sequence = ch.sequence;
            input.dataset.case = ch.case;
            input.dataset.prefix = ch.prefix || '';
            input.dataset.suffix = ch.suffix || '';
            input.dataset.withoutSpace = ch.without_space || '';
            input.dataset.crossStatus = ch.cross_status;
            input.dataset.matDesc = ch.mat_desc;
            row.appendChild(input);
            container.appendChild(row);
          });
      }

      /** Generate summary and optionally submit to Google Sheets */
      function generateSummary() {
        const clsName = document.getElementById('classInput').value;
        const clsObj = findClass(clsName);
        if (!clsObj) {
          alert('Please select a valid class');
          return;
        }
        const server = document.getElementById('serverRef').value.trim();
        const mid = document.getElementById('midRef').value.trim();
        const company = document.getElementById('companySelect').value;
        // Collect characteristic input rows
        const rows = Array.from(
          document.querySelectorAll('#charContainer input, #charContainer select')
        );
        const values = [];
        const matDescParts = [];
        rows
          .sort((a, b) => parseInt(a.dataset.sequence) - parseInt(b.dataset.sequence))
          .forEach((el) => {
            const rawVal = el.value.trim();
            const seq = parseInt(el.dataset.sequence);
            const prefix = el.dataset.prefix || '';
            const suffix = el.dataset.suffix || '';
            const withoutSpace = el.dataset.withoutSpace === 'Y';
            let transformed = rawVal;
            const caseFlag = el.dataset.case;
            if (caseFlag === 'U') transformed = rawVal.toUpperCase();
            else if (caseFlag === 'L') transformed = rawVal.toLowerCase();
            else if (caseFlag === 'P') transformed = toTitleCase(rawVal);
            const finalVal = `${prefix}${transformed}${suffix}`;
            if (el.dataset.matDesc === 'Y') {
              matDescParts.push(finalVal);
            }
            values.push({
              sequence: seq,
              characteristicName: el.dataset.charName,
              inputValue: rawVal,
              transformedValue: finalVal,
              crossPlant: el.dataset.crossStatus,
              mdFlag: el.dataset.matDesc,
              case: caseFlag,
              prefix: prefix,
              suffix: suffix,
              withoutSpace: el.dataset.withoutSpace,
              oldMatNoSeq: '',
              oldMatNo: '',
              midComponent: '',
              qtyComponent: '',
            });
          });
        // Build material description
        let matDesc = matDescParts.filter((p) => p && p.length > 0).join(' ');
        values.forEach((v) => {
          if (v.withoutSpace === 'Y') {
            matDesc = matDesc.replace(` ${v.transformedValue}`, v.transformedValue);
          }
        });
        // Render result
        const resultEl = document.getElementById('resultSection');
        resultEl.innerHTML = '';
        const header = document.createElement('h2');
        header.textContent = 'Result';
        resultEl.appendChild(header);
        const meta = document.createElement('p');
        meta.innerHTML =
          `Server Reference: <strong>${server}</strong><br>` +
          `MID Reference: <strong>${mid}</strong><br>` +
          `Company Use For: <strong>${company}</strong><br>` +
          `Hasil Mat Desc: <strong>${matDesc}</strong>`;
        resultEl.appendChild(meta);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        [
          'Sequence',
          'Characteristic Name',
          'Input Value',
          'Transformed Value',
          'Cross-Plant Material Status',
          'Material Description Flag',
          'Case',
          'Prefix',
          'Suffix',
          'Without Space',
          'Old Mat. Number Sequence',
          'Old Material No.',
          'MID Component',
          'Qty Component',
        ].forEach((txt) => {
          const th = document.createElement('th');
          th.textContent = txt;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        values.forEach((v) => {
          const tr = document.createElement('tr');
          [
            v.sequence,
            v.characteristicName,
            v.inputValue,
            v.transformedValue,
            v.crossPlant,
            v.mdFlag,
            v.case,
            v.prefix,
            v.suffix,
            v.withoutSpace,
            v.oldMatNoSeq,
            v.oldMatNo,
            v.midComponent,
            v.qtyComponent,
          ].forEach((cell) => {
            const td = document.createElement('td');
            td.textContent = cell || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        resultEl.appendChild(table);
        // Prepare payload for submission
        const payload = {
          timestamp: new Date().toISOString(),
          className: clsName,
          server,
          mid,
          company,
          matDesc,
          values,
        };
        if (SUBMIT_URL) {
          sendToSheet(payload);
        }
      }

      /** Submit the payload to a Google Apps Script endpoint */
      async function sendToSheet(payload) {
        try {
          await fetch(SUBMIT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
        } catch (err) {
          console.warn('Submission failed', err);
        }
      }

      /** Reset the form to its initial state */
      function resetForm() {
        document.getElementById('classInput').value = '';
        document.getElementById('serverRef').value = '';
        document.getElementById('midRef').value = '';
        document.getElementById('companySelect').selectedIndex = 0;
        clearCharacteristics();
        document.getElementById('resultSection').innerHTML = '';
      }

      // Initialise the form on page load
      window.addEventListener('DOMContentLoaded', async () => {
        await loadData();
        populateCompanies();
        populateClassList();
        document
          .getElementById('classInput')
          .addEventListener('change', (e) => {
            const cls = findClass(e.target.value);
            buildCharacteristics(cls);
          });
        document
          .getElementById('generateBtn')
          .addEventListener('click', generateSummary);
        document
          .getElementById('resetBtn')
          .addEventListener('click', resetForm);
      });
    </script>
  </body>
</html>